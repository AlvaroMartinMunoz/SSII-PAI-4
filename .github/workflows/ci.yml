name: CI + DevSecOps

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read
  issues: write

jobs:
  devsecops-pipeline:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout del código
      - name: Checkout code
        uses: actions/checkout@v3

      # 2) Clone y arrancar DefectDojo
      - name: Clone DefectDojo
        run: git clone https://github.com/DefectDojo/django-DefectDojo.git defectdojo

      - name: Start DefectDojo
        run: |
          cd defectdojo
          docker compose up -d

      - name: Wait for DefectDojo to be ready
        run: |
          until curl -s http://localhost:8080/api/v2/products/; do
            echo "Waiting for DefectDojo…"
            sleep 10
          done

      # 3) Preparar carpeta de reportes
      - name: Create reportes directory
        run: mkdir -p reportes

      # --- Levantar la app para DAST ---
      - name: Start the app
        run: |
          nohup npm start > app.log 2>&1 &
          sleep 15

      # 10) DAST: OWASP ZAP Baseline
      - name: Run OWASP ZAP Baseline Scan (DAST)
        uses: zaproxy/action-baseline@v0.8.0
        with:
          target: "http://localhost:3000"
          docker_name: "zaproxy/zap-stable"
          allow_issue_writing: true
          artifact_name: "zap-scan"
        continue-on-error: true

      - name: Move ZAP reports into reportes
        run: |
          mv report_html.html report_json.json report_md.md reportes/

      - name: Upload ZAP Scan Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-artifacts
          path: reportes

      # 11) Importar reportes desde reportes/ a DefectDojo
      - name: Upload npm audit report to DefectDojo
        uses: ivanamat/defectdojo-import-scan@v1
        with:
          token: ${{ secrets.DEFECTDOJO_TOKEN }}
          defectdojo_url: http://localhost:8080
          file: reportes/audit-report.json
          scan_type: "NPM Audit"
          engagement: ${{ secrets.DEFECTDOJO_ENGAGEMENT }}

      - name: Upload ZAP JSON report to DefectDojo
        if: success() && hashFiles('reportes/report_json.json') != ''
        uses: ivanamat/defectdojo-import-scan@v1
        with:
          token: ${{ secrets.DEFECTDOJO_TOKEN }}
          defectdojo_url: http://localhost:8080
          file: reportes/report_json.json
          scan_type: "ZAP Baseline Scan"
          engagement: ${{ secrets.DEFECTDOJO_ENGAGEMENT }}
