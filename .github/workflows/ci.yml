name: CI + DevSecOps

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read
  issues: write

jobs:
  devsecops-pipeline:
    runs-on: ubuntu-latest

    steps:
      # 0) Crear carpeta de reportes
      - name: Create reportes directory
        run: mkdir -p reportes

      # 1) Checkout del cÃ³digo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2) Instalar Docker Compose (si no estÃ¡)
      - name: Setup Docker Compose
        run: |
          docker compose version || (
            curl -L https://github.com/docker/compose/releases/download/v2.6.1/docker-compose-$(uname -s)-$(uname -m) \
              -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
          )

      # 3) Clonar y arrancar DefectDojo
      - name: Clone DefectDojo
        run: git clone https://github.com/DefectDojo/django-DefectDojo.git defectdojo

      - name: Start DefectDojo
        run: |
          cd defectdojo
          docker-compose up -d

      - name: Wait for DefectDojo to be ready
        run: |
          until curl -s http://localhost:8080/api/v2/products/; do
            echo "Waiting for DefectDojoâ€¦"
            sleep 10
          done

      # 4) Setup Node.js y dependencias
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16"

      - name: Install dependencies
        run: npm ci

      # 5) Tests unitarios
      - name: Run unit tests
        run: npm test

      # 6) SCA: npm audit â†’ reportes/audit-report.json
      - name: Audit dependencies and fail on high vulnerabilities (SCA)
        run: |
          echo "Running npm audit..."
          npm audit --json > reportes/audit-report.json || true
          echo "ðŸ§¾ Audit report:"
          cat reportes/audit-report.json
          echo "ðŸ” Checking for high severity vulnerabilities..."
          if grep -q '"severity":"high"' reportes/audit-report.json; then
            echo "âŒ High vulnerabilities found."
            exit 1
          else
            echo "âœ… No high vulnerabilities found."
          fi

      # 7) SAST: Semgrep
      - name: Run Semgrep (SAST)
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/default"
        continue-on-error: true

      # 8) IaC Security: Trivy
      - name: Trivy IaC scan (Dockerfile example)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: .
        continue-on-error: true

      # 9) Levantar la app para DAST
      - name: Start the app
        run: |
          nohup npm start > app.log 2>&1 &
          sleep 15

      - name: Upload app startup logs
        uses: actions/upload-artifact@v4
        with:
          name: app-logs
          path: app.log

      # 10) DAST: OWASP ZAP Baseline â†’ mueve sus reports a reportes/
      - name: Run OWASP ZAP Baseline Scan (DAST)
        uses: zaproxy/action-baseline@v0.8.0
        with:
          target: "http://localhost:3000"
          docker_name: "zaproxy/zap-stable"
          allow_issue_writing: true
        continue-on-error: true

      - name: Move ZAP reports into reportes
        run: |
          mv report_html.html report_json.json report_md.md reportes/

      - name: Upload ZAP Report (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: reportes

      # 11) Importar reportes desde reportes/ a DefectDojo
      - name: Upload npm audit report to DefectDojo
        uses: ivanamat/defectdojo-import-scan@v1
        with:
          token: ${{ secrets.DEFECTDOJO_TOKEN }}
          defectdojo_url: http://localhost:8080
          file: reportes/audit-report.json
          scan_type: "NPM Audit"
          engagement: ${{ secrets.DEFECTDOJO_ENGAGEMENT }}

      - name: Upload ZAP JSON report to DefectDojo
        uses: ivanamat/defectdojo-import-scan@v1
        with:
          token: ${{ secrets.DEFECTDOJO_TOKEN }}
          defectdojo_url: http://localhost:8080
          file: reportes/report_json.json
          scan_type: "ZAP Baseline Scan"
          engagement: ${{ secrets.DEFECTDOJO_ENGAGEMENT }}
